{% extends "base.html" %}

{% block title %}{% if account %}口座編集{% else %}口座新規追加{% endif %} - 会計システム{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 600px;
        margin: 0 auto;
        background-color: white;
        padding: 2rem;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #333;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        font-family: inherit;
    }
    
    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
    }
    
    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }
    
    .form-actions button,
    .form-actions a {
        flex: 1;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        text-decoration: none;
        text-align: center;
    }
    
    .required {
        color: #e74c3c;
    }
    
    .form-section {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid #e0e0e0;
    }
    
    .form-section h3 {
        margin-bottom: 1.5rem;
        color: #2c3e50;
        font-size: 1.2rem;
    }
    
    .form-hint {
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<h2>{% if account %}口座編集{% else %}口座新規追加{% endif %}</h2>

<div class="form-container">
    <form method="POST" action="{% if account %}{{ url_for('accounts.account_edit', account_id=account.id) }}{% else %}{{ url_for('accounts.account_create') }}{% endif %}">
        <div class="form-group">
            <label for="account_name">口座名 <span class="required">*</span></label>
            <input type="text" id="account_name" name="account_name" value="{{ account.account_name if account else '' }}" required>
        </div>
        
        <div class="form-group">
            <label for="account_type">口座種別 <span class="required">*</span></label>
            <select id="account_type" name="account_type" required>
                <option value="">選択してください</option>
                <option value="現金" {% if account and account.account_type == '現金' %}selected{% endif %}>現金</option>
                <option value="普通預金" {% if account and account.account_type == '普通預金' %}selected{% endif %}>普通預金</option>
                <option value="当座預金" {% if account and account.account_type == '当座預金' %}selected{% endif %}>当座預金</option>
                <option value="定期預金" {% if account and account.account_type == '定期預金' %}selected{% endif %}>定期預金</option>
                <option value="クレジットカード" {% if account and account.account_type == 'クレジットカード' %}selected{% endif %}>クレジットカード</option>
                <option value="電子決済" {% if account and account.account_type == '電子決済' %}selected{% endif %}>電子決済</option>
                <option value="その他" {% if account and account.account_type == 'その他' %}selected{% endif %}>その他</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="display_name">決算書表示名</label>
            <input type="text" id="display_name" name="display_name" value="{{ account.display_name if account else '' }}">
        </div>
        
        <div class="form-group">
            <label for="bank_name">銀行名</label>
            <input type="text" id="bank_name" name="bank_name" value="{{ account.bank_name if account else '' }}">
        </div>
        
        <div class="form-group">
            <label for="branch_name">支店名</label>
            <input type="text" id="branch_name" name="branch_name" value="{{ account.branch_name if account else '' }}">
        </div>
        
        <div class="form-group">
            <label for="account_number">口座番号</label>
            <input type="text" id="account_number" name="account_number" value="{{ account.account_number if account else '' }}">
        </div>
        
        <div class="form-group">
            <label for="memo">メモ</label>
            <textarea id="memo" name="memo">{{ account.memo if account else '' }}</textarea>
        </div>
        
        <!-- 勘定科目詳細情報 -->
        <div class="form-section">
            <h3>勘定科目詳細情報</h3>
            <div class="form-hint">口座登録時に自動作成される勘定科目の詳細情報を入力してください。</div>
            
            <div class="form-group">
                <label for="major_category">大分類 <span class="required">*</span></label>
                <select id="major_category" name="major_category" required>
                    <option value="">選択してください</option>
                    {% for major in categories.keys() %}
                    <option value="{{ major }}" {% if account_item and account_item.major_category == major %}selected{% endif %}>{{ major }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="mid_category">中分類 <span class="required">*</span></label>
                <select id="mid_category" name="mid_category" required>
                    <option value="">選択してください</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="sub_category">小分類 <span class="required">*</span></label>
                <select id="sub_category" name="sub_category" required>
                    <option value="">選択してください</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="income_counterpart">収入取引相手方 <span class="required">*</span></label>
                <select id="income_counterpart" name="income_counterpart" required>
                    <option value="">選択してください</option>
                    {% for option in options.income_counterparts %}
                    <option value="{{ option }}" {% if account_item and account_item.income_counterpart == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="expense_counterpart">支出取引相手方 <span class="required">*</span></label>
                <select id="expense_counterpart" name="expense_counterpart" required>
                    <option value="">選択してください</option>
                    {% for option in options.expense_counterparts %}
                    <option value="{{ option }}" {% if account_item and account_item.expense_counterpart == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="tax_category">税区分 <span class="required">*</span></label>
                <select id="tax_category" name="tax_category" required>
                    <option value="">選択してください</option>
                    {% for option in options.tax_categories %}
                    <option value="{{ option }}" {% if account_item and account_item.tax_category == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-success">{% if account %}更新{% else %}作成{% endif %}</button>
            <a href="{{ url_for('accounts.accounts_list') }}" class="btn btn-secondary">キャンセル</a>
        </div>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // 分類階層データ
    const categories = {{ categories|tojson }};
    
    const majorSelect = document.getElementById('major_category');
    const midSelect = document.getElementById('mid_category');
    const subSelect = document.getElementById('sub_category');
    
    // 大分類変更時に中分類を更新
    majorSelect.addEventListener('change', function() {
        const selectedMajor = this.value;
        midSelect.innerHTML = '<option value="">選択してください</option>';
        subSelect.innerHTML = '<option value="">選択してください</option>';
        
        if (selectedMajor && categories[selectedMajor]) {
            Object.keys(categories[selectedMajor]).forEach(mid => {
                const option = document.createElement('option');
                option.value = mid;
                option.textContent = mid;
                midSelect.appendChild(option);
            });
        }
    });
    
    // 中分類変更時に小分類を更新
    midSelect.addEventListener('change', function() {
        const selectedMajor = majorSelect.value;
        const selectedMid = this.value;
        subSelect.innerHTML = '<option value="">選択してください</option>';
        
        if (selectedMajor && selectedMid && categories[selectedMajor] && categories[selectedMajor][selectedMid]) {
            categories[selectedMajor][selectedMid].forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                subSelect.appendChild(option);
            });
        }
    });
    
    // 編集時の初期値設定
    {% if account_item %}
    window.addEventListener('DOMContentLoaded', function() {
        const initialMajor = '{{ account_item.major_category }}';
        const initialMid = '{{ account_item.mid_category }}';
        const initialSub = '{{ account_item.sub_category }}';
        
        if (initialMajor) {
            // 中分類の選択肢を設定
            if (categories[initialMajor]) {
                Object.keys(categories[initialMajor]).forEach(mid => {
                    const option = document.createElement('option');
                    option.value = mid;
                    option.textContent = mid;
                    if (mid === initialMid) {
                        option.selected = true;
                    }
                    midSelect.appendChild(option);
                });
            }
            
            // 小分類の選択肢を設定
            if (initialMid && categories[initialMajor] && categories[initialMajor][initialMid]) {
                categories[initialMajor][initialMid].forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    if (sub === initialSub) {
                        option.selected = true;
                    }
                    subSelect.appendChild(option);
                });
            }
        }
    });
    {% endif %}
</script>
{% endblock %}
